name: Deploy to Development
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image to deploy'
        required: true
      sha:
        description: 'Git SHA of the commit'
        required: true
      commit_message:
        description: 'Original commit message'
        required: true
  
jobs:
  deploy-backend-development:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Display Deployment Information
        run: |
          echo "Image: ${{ github.event.inputs.image }}"
          echo "SHA: ${{ github.event.inputs.sha }}"
          echo "Commit Message: ${{ github.event.inputs.commit_message }}"

      - name: Checkout repository code
        uses: actions/checkout@v4
  
      - name: Set docker image tag from workflow input
        run: echo "BACKEND_IMAGE=${{ github.event.inputs.image }}" >> $GITHUB_ENV
          
      - name: Update deployment image tags
        run: |
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/backend-deployment.yaml
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/celery-worker-default-deployment.yaml
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/celery-enrichment-worker-deployment.yaml
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/celery-bulk-upload-worker-deployment.yaml
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/celery-question-generator-ai-worker-deployment.yaml
          yq -i '.spec.template.spec.containers[0].image = env(BACKEND_IMAGE)' k8s/base/deployment/celery-flower-deployment.yaml
          
      - name: Commit and push changes
        run: |
          git config --local user.email "hariharen@greatify.ai"
          git config --local user.name "Hariharen"
          git add k8s/base/deployment/backend-deployment.yaml
          git add k8s/base/deployment/celery-worker-default-deployment.yaml
          git add k8s/base/deployment/celery-enrichment-worker-deployment.yaml
          git add k8s/base/deployment/celery-bulk-upload-worker-deployment.yaml
          git add k8s/base/deployment/celery-question-generator-ai-worker-deployment.yaml
          git add k8s/base/deployment/celery-flower-deployment.yaml
          git commit -m "Update image tags for development deployment"
          git push origin main
          
      # - name: Push to protected branch
      #   uses: CasperWA/push-protected@v2
      #   with:
      #     token: ${{ secrets.PAT_TOKEN }}
      #     branch: dev
      #     unprotect_reviews: true

      - name: Configure AWS credentials for deployment
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update Kubernetes configuration
        run: aws eks update-kubeconfig --name dev-stg-cluster --region ap-south-1

      - name: Deploy to development environment
        run: |
          kubectl apply -k k8s/overlays/dev
          
      - name: Send deployment success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,ref,workflow,eventName
          author_name: Backend Deployment Success
          mention: ${{ github.actor }}
          if_mention: success
          job_name: deploy-backend-development
          channel: examxv2-backend-alerts
          username: ExamX-V2-CICD
          text: |
            :rocket: *Deployment to dev environment succeeded*
            
            *Deployment by:* @${{ github.actor }}
            *Commit:* ${{ github.sha }}
            *Commit message:* ${{ github.event.inputs.commit_message }}
            
            @${{ github.actor }}, your changes have been deployed successfully to Development.
            Please verify the deployment and conduct necessary tests.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

name: Deploy Lambda Functions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stg
          - prod
      lambda:
        description: 'Lambda to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - fcm
          - exam-submission
          - enrichment
          - question-generator-ai
          - bulk-export
          - default

env:
  AWS_REGION: ap-south-1
  AWS_ACCOUNT_ID: '399600302704'
  ECR_REPOSITORY: examx-lambda

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    strategy:
      matrix:
        lambda: [fcm, exam-submission, enrichment, question-generator-ai, bulk-export, default]
      fail-fast: false
    steps:
      - name: Checkout backend repo (contains lambda code)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/ExamX-V2-Backend
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get Lambda directory
        id: lambda-dir
        run: |
          case "${{ matrix.lambda }}" in
            "exam-submission") echo "dir=exam_submission" >> $GITHUB_OUTPUT ;;
            "question-generator-ai") echo "dir=question_generator_ai" >> $GITHUB_OUTPUT ;;
            "bulk-export") echo "dir=bulk_export" >> $GITHUB_OUTPUT ;;
            *) echo "dir=${{ matrix.lambda }}" >> $GITHUB_OUTPUT ;;
          esac

      - name: Get secrets ARN for environment
        id: secrets-arn
        run: |
          case "${{ github.event.inputs.environment }}" in
            "dev") echo "arn=examxv2-secrets-1uLP4S" >> $GITHUB_OUTPUT ;;
            "stg") echo "arn=examxv2-secrets-stg" >> $GITHUB_OUTPUT ;;
            "prod") echo "arn=examxv2-secrets-prod" >> $GITHUB_OUTPUT ;;
            *) echo "arn=examxv2-secrets-1uLP4S" >> $GITHUB_OUTPUT ;;
          esac

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ENV: ${{ github.event.inputs.environment }}
          LAMBDA_DIR: ${{ steps.lambda-dir.outputs.dir }}
          LAMBDA_NAME: ${{ matrix.lambda }}
          SECRETS_ARN: ${{ steps.secrets-arn.outputs.arn }}
        run: |
          # Copy common utilities to Lambda directory
          cp -r lambda/common lambda/$LAMBDA_DIR/
          
          # Image tag: {lambda-name}-{environment}
          IMAGE_TAG="${LAMBDA_NAME}-${ENV}"
          
          # Build image
          docker build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -f lambda/$LAMBDA_DIR/Dockerfile \
            lambda/$LAMBDA_DIR
          
          # Push image
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "Pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Update Lambda function
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ENV: ${{ github.event.inputs.environment }}
          LAMBDA_NAME: ${{ matrix.lambda }}
          SECRETS_ARN: ${{ steps.secrets-arn.outputs.arn }}
        run: |
          FUNCTION_NAME="examx-${ENV}-lambda-${LAMBDA_NAME}"
          IMAGE_TAG="${LAMBDA_NAME}-${ENV}"
          
          # Update Lambda code
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --image-uri $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || true
          
          # Update Lambda env vars
          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --environment "Variables={LAMBDA_ENV=${ENV},AWS_REGION=${{ env.AWS_REGION }},SECRETS_ARN=${SECRETS_ARN}}" 2>/dev/null || true

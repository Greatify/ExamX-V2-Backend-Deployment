apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: uat-examxv2

resources:
  - ../../base
  - storage/pv.yaml
  - storage/pvc.yaml

labels:
  - pairs:
      environment: uat
      tier: uat
    includeSelectors: false

patches:
  # Update backend configuration for UAT
  - target:
      kind: Deployment
      name: examxv2-backend
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: WORKERS
            value: "2"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"

  # Update celery-worker configuration for UAT
  - target:
      kind: Deployment
      name: celery-worker-default
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"

  # Update celery-bulk-upload-worker configuration for UAT
  - target:
      kind: Deployment
      name: celery-bulk-upload-worker
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"

  # Update celery-enrichment-worker configuration for UAT
  - target:
      kind: Deployment
      name: celery-enrichment-worker
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"

  # Update celery-question-generator-ai-worker configuration for UAT
  - target:
      kind: Deployment
      name: celery-question-generator-ai-worker
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"



  # Ingress patches - Using klockwork.ai domain
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: examxv2-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/b1a2ebc1-bf6b-4a73-a7f9-69ad12e8c4c9
          alb.ingress.kubernetes.io/auth-tls-verify-client: "optional"
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://klockwork.ai,https://www.klockwork.ai,https://*.klockwork.ai
      spec:
        tls:
          - hosts:
              - klockwork.ai
            secretName: tls-secret
    target:
      kind: Ingress
      name: examxv2-ingress

  # Celery Flower patches for UAT
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-flower
      spec:
        replicas: 1
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: flower
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250819-134703-5b1c7c38569202ee6e0dfaeba803708d8c1bf182"
              resources:
                requests:
                  cpu: "1"
                  memory: "4Gi"
                limits:
                  cpu: "2"
                  memory: "8Gi"
    target:
      kind: Deployment
      name: celery-flower

  # Secrets patches - Using UAT secret ARN
  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-backend-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-backend-uat-9G4vRf
              objectAlias: ".env"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-backend-secrets 


  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-google-credentials
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-backend-googlecredentials-dev-zQode4
              objectAlias: "google-credentials.json"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-google-credentials

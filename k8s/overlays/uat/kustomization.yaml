apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: uat-examxv2

resources:
  - ../../base
  - storage/pv.yaml
  - storage/pvc.yaml

labels:
  - pairs:
      environment: uat
      tier: uat
    includeSelectors: false

patches:
  # Update backend configuration for UAT
  - target:
      kind: Deployment
      name: examxv2-backend
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: WORKERS
            value: "2"
          - name: OPIK_URL_OVERRIDE
            value: "https://www.comet.com/opik/api"
          - name: OPIK_API_KEY
            value: "Y5T3WoqNxJ22ypw1M8qivydis"
          - name: OPIK_WORKSPACE
            value: "greatify-prod"
          - name: OPIK_PROJECT_NAME
            value: "UAT"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250822-073958-e2126036359743e3dd813d53597ff049c304d30a"

  # ===== OPTIMIZED CELERY WORKERS (3-Queue Architecture) =====
  
  # CPU-Intensive Worker for AI tasks, bulk operations
  - target:
      kind: Deployment
      name: celery-cpu-worker
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "2.5"      # 2.5 cores for UAT (close to production)
            memory: "10Gi"  # 10GB for UAT
          limits:
            cpu: "3.5"      # 3.5 cores max for UAT
            memory: "14Gi"  # 14GB max for UAT
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: OPIK_URL_OVERRIDE
            value: "https://www.comet.com/opik/api"
          - name: OPIK_API_KEY
            value: "Y5T3WoqNxJ22ypw1M8qivydis"
          - name: OPIK_WORKSPACE
            value: "greatify-prod"
          - name: OPIK_PROJECT_NAME
            value: "UAT"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250822-073958-e2126036359743e3dd813d53597ff049c304d30a"

  # I/O-Intensive Worker for email, external APIs
  - target:
      kind: Deployment
      name: celery-io-worker
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "900m"     # 0.9 cores for UAT
            memory: "2.5Gi" # 2.5GB for UAT
          limits:
            cpu: "1.5"      # 1.5 cores max for UAT
            memory: "3.5Gi" # 3.5GB max for UAT
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: OPIK_URL_OVERRIDE
            value: "https://www.comet.com/opik/api"
          - name: OPIK_API_KEY
            value: "Y5T3WoqNxJ22ypw1M8qivydis"
          - name: OPIK_WORKSPACE
            value: "greatify-prod"
          - name: OPIK_PROJECT_NAME
            value: "UAT"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250822-073958-e2126036359743e3dd813d53597ff049c304d30a"

  # Mixed Processing Worker for general tasks
  - target:
      kind: Deployment
      name: celery-mixed-worker
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "900m"     # 0.9 cores for UAT
            memory: "5Gi"   # 5GB for UAT
          limits:
            cpu: "1.5"      # 1.5 cores max for UAT
            memory: "7Gi"   # 7GB max for UAT
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: OPIK_URL_OVERRIDE
            value: "https://www.comet.com/opik/api"
          - name: OPIK_API_KEY
            value: "Y5T3WoqNxJ22ypw1M8qivydis"
          - name: OPIK_WORKSPACE
            value: "greatify-prod"
          - name: OPIK_PROJECT_NAME
            value: "UAT"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250822-073958-e2126036359743e3dd813d53597ff049c304d30a"

  # ===== OLD WORKERS REPLACED BY OPTIMIZED ARCHITECTURE =====
  # celery-worker-default → replaced by celery-mixed-worker
  # celery-bulk-upload-worker → replaced by celery-cpu-worker  
  # celery-enrichment-worker → replaced by celery-cpu-worker
  # celery-question-generator-ai-worker → replaced by celery-cpu-worker

  # Update celery-flower configuration for UAT
  - target:
      kind: Deployment
      name: celery-flower
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: examxv2-stg-secret-service
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "250m"
            memory: "1Gi"
          limits:
            cpu: "500m"
            memory: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:uat-20250822-073958-e2126036359743e3dd813d53597ff049c304d30a"

  # Update ingress configuration for UAT
  - target:
      kind: Ingress
      name: examxv2-ingress
    patch: |-
      - op: replace
        path: /metadata/annotations
        value:
          kubernetes.io/ingress.class: alb
          alb.ingress.kubernetes.io/scheme: internet-facing
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/3ac85857-f810-414f-903b-1ab46d8e1520
          alb.ingress.kubernetes.io/auth-tls-verify-client: "optional"
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://examx.co,https://www.examx.co,https://*.examx.co

  # Update secrets for UAT  
  - target:
      kind: SecretProviderClass
      name: examxv2-backend-secrets
    patch: |-
      - op: replace
        path: /spec/parameters/objects
        value: |
          - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-stage-secrets-DKS1E3
            objectAlias: ".env"
            objectType: "secretsmanager"

  - target:
      kind: SecretProviderClass
      name: examxv2-google-credentials
    patch: |-
      - op: replace
        path: /spec/parameters/objects
        value: |
          - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-backend-googlecredentials-stg-w86vvd
            objectAlias: "google-credentials.json"
            objectType: "secretsmanager"
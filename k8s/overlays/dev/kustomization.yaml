apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dev-examxv2

# Reference base kustomization (avoids security restrictions)
# PDB resources are excluded via patches below
resources:
  # Include base kustomization (includes all base resources)
  - ../../base
  
  # Dev-specific resources
  - storage/pv.yaml
  - storage/pvc.yaml
  
  # NOTE: PDB resources from base are excluded via $patch: delete patches below

# Using labels instead of deprecated commonLabels
labels:
  - pairs:
      environment: development
      tier: dev
    includeSelectors: false

# Using patches instead of deprecated patchesStrategicMerge
patches:
  # Backend Deployment patches - only mutable fields
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: examxv2-backend
        annotations:
          kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
      spec:
        replicas: 1
        template:
          spec:
            serviceAccountName: dev-examxv2-sa
            containers:
            - name: examxv2-backend
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
              resources:
                requests:
                  cpu: "2"
                  memory: "6Gi"
                limits:
                  cpu: "3"
                  memory: "8Gi"
              env:
              - name: WORKERS
                value: "4"
              
              # OpenTelemetry resource attributes for dev environment
              - name: OTEL_RESOURCE_ATTRIBUTES
                value: "service.version=1.0.0,deployment.environment=development,k8s.cluster.name=greatify-dev-stg-cluster"
              
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Dev"
              - name: REDIS_URL
                value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
    target:
      kind: Deployment
      name: examxv2-backend

  # Celery Worker patches - only mutable fields
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-worker-default
        annotations:
          kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
      spec:
        replicas: 0
        template:
          spec:
            serviceAccountName: dev-examxv2-sa
            containers:
            - name: celery-worker-default
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
              resources: null  # Commented out for dev environment
              # resources:
              #   requests:
              #     cpu: "200m"
              #     memory: "2Gi"
              #   limits:
              #     cpu: "400m"
              #     memory: "3Gi"
              command:
              - celery
              - -A
              - examx
              - worker
              - -P
              - gevent
              - -c
              - "25"
              - -Q
              - default
              - -l
              - info
              - -E
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Dev"
              - name: REDIS_URL
                value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
    target:
      kind: Deployment
      name: celery-worker-default
  # Celery Bulk Upload Worker patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-bulk-upload-worker
        annotations:
          kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
      spec:
        replicas: 0
        template:
          spec:
            serviceAccountName: dev-examxv2-sa
            containers:
            - name: celery-bulk-upload-worker
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
              resources: null  # Commented out for dev environment
              # resources:
              #   requests:
              #     cpu: "300m"
              #     memory: "2Gi"
              #   limits:
              #     cpu: "400m"
              #     memory: "3Gi"
              command:
              - celery
              - -A
              - examx
              - worker
              - -P
              - prefork
              - -c
              - "1"
              - -Q
              - bulk_upload
              - -l
              - info
              - -E
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME 
                value: "Dev"
              - name: REDIS_URL
                value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
    target:
      kind: Deployment
      name: celery-bulk-upload-worker

  # Celery Bulk Export Worker patches
  # - patch: |-
  #     apiVersion: apps/v1
  #     kind: Deployment
  #     metadata:
  #       name: celery-bulk-export-worker
  #       annotations:
  #         kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #     spec:
  #       replicas: 1
  #       template:
  #         spec:
  #           serviceAccountName: dev-examxv2-sa
  #           containers:
  #           - name: celery-bulk-export-worker
  #             image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #             resources: null  # Commented out for dev environment
  #             # resources:
  #             #   requests:
  #             #     cpu: "1"
  #             #     memory: "8Gi"
  #             #   limits:
  #             #     cpu: "2"
  #             #     memory: "12Gi"
  #             command:
  #             - celery
  #             - -A
  #             - examx
  #             - worker
  #             - -P
  #             - prefork
  #             - -c
  #             - "1"
  #             - -Q
  #             - bulk_export
  #             - -l
  #             - info
  #             - -E
  #             env:
  #             - name: OPIK_URL_OVERRIDE
  #               value: "https://www.comet.com/opik/api"
  #             - name: OPIK_API_KEY
  #               value: "Y5T3WoqNxJ22ypw1M8qivydis"
  #             - name: OPIK_WORKSPACE
  #               value: "greatify-prod"
  #             - name: OPIK_PROJECT_NAME
  #               value: "Dev"
  #             - name: REDIS_URL
  #               value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
  #   target:
  #     kind: Deployment
  #     name: celery-bulk-export-worker

  # Celery Enrichment Worker patches - disabled in dev
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-enrichment-worker
      spec:
        replicas: 0
        template:
          spec:
            containers:
            - name: celery-enrichment-worker
              resources: null  # Commented out for dev environment
              # resources:
              #   requests:
              #     cpu: "300m"
              #     memory: "2Gi"
              #   limits:
              #     cpu: "500m"
              #     memory: "3Gi"
    target:
      kind: Deployment
      name: celery-enrichment-worker

  # # Celery Exam Submission Worker patches
  # - patch: |-
  #     apiVersion: apps/v1
  #     kind: Deployment
  #     metadata:
  #       name: celery-exam-submission-worker
  #       annotations:
  #         kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #     spec:
  #       replicas: 1
  #       template:
  #         spec:
  #           serviceAccountName: dev-examxv2-sa
  #           containers:
  #           - name: celery-exam-submission-worker
  #             image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #             resources: null  # Commented out for dev environment
  #             # resources:
  #             #   requests:
  #             #     cpu: "300m"
  #             #     memory: "2Gi"
  #             #   limits:
  #             #     cpu: "500m"
  #             #     memory: "3Gi"
  #             command:
  #               - celery
  #               - -A
  #               - examx
  #               - worker
  #               - --pool=prefork
  #               - --concurrency=16
  #               - --queues=exam_submissions
  #               - --hostname=exam_worker@%h
  #               - --max-tasks-per-child=50
  #               - --time-limit=120
  #               - --loglevel=info
  #               - -E
  #             env:
  #             - name: OPIK_URL_OVERRIDE
  #               value: "https://www.comet.com/opik/api"
  #             - name: OPIK_API_KEY
  #               value: "Y5T3WoqNxJ22ypw1M8qivydis"
  #             - name: OPIK_WORKSPACE
  #               value: "greatify-prod"
  #             - name: OPIK_PROJECT_NAME
  #               value: "Dev"
  #             - name: REDIS_URL
  #               value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
  #   target:
  #     kind: Deployment
  #     name: celery-exam-submission-worker

  # Celery Question Generator AI Worker patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-question-generator-ai-worker
        annotations:
          kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
      spec:
        replicas: 0
        template:
          spec:
            serviceAccountName: dev-examxv2-sa
            containers:
            - name: celery-question-generator-ai-worker
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
              resources: null  # Commented out for dev environment
              # resources:
              #   requests:
              #     cpu: "200m"
              #     memory: "2Gi"
              #   limits:
              #     cpu: "400m"
              #     memory: "3Gi"
              command:
              - celery
              - -A
              - examx
              - worker
              - -P
              - gevent
              - -c
              - "25"
              - -Q
              - question_generator_ai
              - -l
              - info
              - -E
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Dev"
              - name: REDIS_URL
                value: "rediss://master.examxv2-dev.kti2un.aps1.cache.amazonaws.com:6379"
    target:
      kind: Deployment
      name: celery-question-generator-ai-worker

  # # Celery Flower patches for dev
  # - patch: |-
  #     apiVersion: apps/v1
  #     kind: Deployment
  #     metadata:
  #       name: celery-flower
  #       annotations:
  #         kubernetes.io/change-cause: Updated to "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #     spec:
  #       replicas: 1
  #       template:
  #         spec:
  #           serviceAccountName: dev-examxv2-sa
  #           containers:
  #           - name: flower
  #             image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:dev-EXM-3298-Removed-the-ensure-connect-e86707c851f376060c84add51ab6a6f15b22fab1"
  #             resources: null  # Commented out for dev environment
  #             # resources:
  #             #   requests:
  #             #     cpu: "200m"
  #             #     memory: "1Gi"
  #             #   limits:
  #             #     cpu: "400m"
  #             #     memory: "2Gi"
  #   target:
  #     kind: Deployment
  #     name: celery-flower

  # Ingress patches
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: examxv2-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/f191c431-422f-42a6-85ec-13eabec5272f
          alb.ingress.kubernetes.io/auth-tls-verify-client: "optional"
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://examx.cloud,https://www.examx.cloud,https://*.examx.cloud
      spec:
        tls:
          - hosts:
              - examx.cloud
            secretName: tls-secret
    target:
      kind: Ingress
      name: examxv2-ingress

  # Secrets patches
  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-backend-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-secrets-1uLP4S
              objectAlias: ".env"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-backend-secrets

  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-google-credentials
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-backend-googlecredentials-dev-zQode4
              objectAlias: "google-credentials.json"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-google-credentials

  # Disable celery-enrichment-worker-autoscaler in dev
  # - patch: |-
  #     apiVersion: autoscaling/v2
  #     kind: HorizontalPodAutoscaler
  #     metadata:
  #       name: celery-enrichment-worker-autoscaler
  #     spec:
  #       minReplicas: 0
  #       maxReplicas: 1
  #       scaleTargetRef:
  #         apiVersion: apps/v1
  #         kind: Deployment
  #         name: celery-enrichment-worker
  #   target:
  #     kind: HorizontalPodAutoscaler
  #     name: celery-enrichment-worker-autoscaler

  # KEDA ScaledObject patches for dev environment
  - patch: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: celery-worker-default-scaler
      spec:
        minReplicaCount: 0
        maxReplicaCount: 3 
        cooldownPeriod: 30
        triggers:
        - type: prometheus
          metadata:
            serverAddress: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
            metricName: "celery_default_queue_backlog"
            threshold: "1"
            query: |
              sum(examx_celery_queue_pending{queue="default",namespace="dev-examxv2"} + examx_celery_queue_active{queue="default",namespace="dev-examxv2"})
    target:
      kind: ScaledObject
      name: celery-worker-default-scaler

  - patch: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: celery-bulk-upload-worker-scaler
      spec:
        minReplicaCount: 0
        maxReplicaCount: 2 
        cooldownPeriod: 30
        triggers:
        - type: prometheus
          metadata:
            serverAddress: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
            metricName: "celery_bulk_upload_queue_backlog"
            threshold: "1"
            query: |
              sum(examx_celery_queue_pending{queue="bulk_upload",namespace="dev-examxv2"} + examx_celery_queue_active{queue="bulk_upload",namespace="dev-examxv2"})
    target:
      kind: ScaledObject
      name: celery-bulk-upload-worker-scaler

  # - patch: |-
  #     apiVersion: keda.sh/v1alpha1
  #     kind: ScaledObject
  #     metadata:
  #       name: celery-bulk-export-worker-scaler
  #     spec:
  #       minReplicaCount: 0
  #       maxReplicaCount: 6 
  #       cooldownPeriod: 30
  #       pollingInterval: 5
  #       triggers:
  #       - type: prometheus
  #         metadata:
  #           serverAddress: "http://prometheus-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090"
  #           metricName: "celery_bulk_export_queue_backlog"
  #           threshold: "1"
  #           query: |
  #             sum(examx_celery_queue_pending{queue="bulk_export"} + examx_celery_queue_active{queue="bulk_export"})
  #   target:
  #     kind: ScaledObject
  #     name: celery-bulk-export-worker-scaler

  - patch: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: celery-enrichment-worker-scaler
      spec:
        minReplicaCount: 0  
        maxReplicaCount: 3 
        cooldownPeriod: 30
        triggers:
        - type: prometheus
          metadata:
            serverAddress: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
            metricName: "celery_enrichment_queue_backlog"
            threshold: "1"
            query: |
              sum(examx_celery_queue_pending{queue="question_enrichment",namespace="dev-examxv2"} + examx_celery_queue_active{queue="question_enrichment",namespace="dev-examxv2"})
    target:
      kind: ScaledObject
      name: celery-enrichment-worker-scaler

  - patch: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: celery-exam-submission-worker-scaler
      spec:
        minReplicaCount: 0
        maxReplicaCount: 3 
        cooldownPeriod: 30
        triggers:
        - type: prometheus
          metadata:
            serverAddress: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
            metricName: "celery_exam_submission_queue_backlog"
            threshold: "1"
            query: |
              sum(examx_celery_queue_pending{queue="exam_submissions",namespace="dev-examxv2"} + examx_celery_queue_active{queue="exam_submissions",namespace="dev-examxv2"})
    target:
      kind: ScaledObject
      name: celery-exam-submission-worker-scaler

  - patch: |-
      apiVersion: keda.sh/v1alpha1
      kind: ScaledObject
      metadata:
        name: celery-question-generator-ai-worker-scaler
      spec:
        minReplicaCount: 0
        maxReplicaCount: 2 
        cooldownPeriod: 30
        triggers:
        - type: prometheus
          metadata:
            serverAddress: "http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090"
            metricName: "celery_question_generator_ai_backlog"
            threshold: "1"
            query: |
              sum(examx_celery_queue_pending{queue="question_generator_ai",namespace="dev-examxv2"} + examx_celery_queue_active{queue="question_generator_ai",namespace="dev-examxv2"})
    target:
      kind: ScaledObject
      name: celery-question-generator-ai-worker-scaler


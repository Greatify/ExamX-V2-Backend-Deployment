apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: stg-examxv2

resources:
  - ../../base
  - storage/pv.yaml
  - storage/pvc.yaml

labels:
  - pairs:
      environment: staging
      tier: stg
    includeSelectors: false

patches:
  # Backend Deployment patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: examxv2-backend
      spec:
        replicas: 1
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: examxv2-backend
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:stg-EXM-1809-Update-Authoring-Module-Re-ad2c938a641b85c2fc9d53c1894737f8ccb540c4"
              resources:
                requests:
                  cpu: "500m"
                  memory: "3Gi"
                limits:
                  cpu: "1"
                  memory: "6Gi"
              env:
              - name: WORKERS
                value: "2"
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Stg"
    target:
      kind: Deployment
      name: examxv2-backend

  # ===== OPTIMIZED CELERY WORKERS (3-Queue Architecture) =====
  
  # CPU-Intensive Worker for AI tasks, bulk operations  
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-cpu-worker
      spec:
        replicas: 2  # Higher replicas for staging testing
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: celery-cpu-worker
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:stg-EXM-1809-Update-Authoring-Module-Re-ad2c938a641b85c2fc9d53c1894737f8ccb540c4"
              resources:
                requests:
                  cpu: "2"        # 2 cores for staging (between dev and prod)
                  memory: "8Gi"   # 8GB for staging
                limits:
                  cpu: "3"        # 3 cores max for staging
                  memory: "12Gi"  # 12GB max for staging
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Stg"
    target:
      kind: Deployment
      name: celery-cpu-worker

  # I/O-Intensive Worker for email, external APIs
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-io-worker
      spec:
        replicas: 2  # Higher replicas for staging testing
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: celery-io-worker
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:stg-EXM-1809-Update-Authoring-Module-Re-ad2c938a641b85c2fc9d53c1894737f8ccb540c4"
              resources:
                requests:
                  cpu: "750m"    # 0.75 cores for staging
                  memory: "1.5Gi" # 1.5GB for staging
                limits:
                  cpu: "1.5"     # 1.5 cores max for staging  
                  memory: "3Gi"  # 3GB max for staging
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Stg"
    target:
      kind: Deployment
      name: celery-io-worker

  # Mixed Processing Worker for general tasks
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-mixed-worker
      spec:
        replicas: 2  # Higher replicas for staging testing
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: celery-mixed-worker
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:stg-EXM-1809-Update-Authoring-Module-Re-ad2c938a641b85c2fc9d53c1894737f8ccb540c4"
              resources:
                requests:
                  cpu: "750m"    # 0.75 cores for staging
                  memory: "3Gi"  # 3GB for staging
                limits:
                  cpu: "1.5"     # 1.5 cores max for staging
                  memory: "6Gi"  # 6GB max for staging
              env:
              - name: OPIK_URL_OVERRIDE
                value: "https://www.comet.com/opik/api"
              - name: OPIK_API_KEY
                value: "Y5T3WoqNxJ22ypw1M8qivydis"
              - name: OPIK_WORKSPACE
                value: "greatify-prod"
              - name: OPIK_PROJECT_NAME
                value: "Stg"
    target:
      kind: Deployment
      name: celery-mixed-worker

  # ===== OLD WORKERS REPLACED BY OPTIMIZED ARCHITECTURE =====
  # celery-worker-default → replaced by celery-mixed-worker
  # celery-bulk-upload-worker → replaced by celery-cpu-worker  
  # celery-enrichment-worker → replaced by celery-cpu-worker
  # celery-question-generator-ai-worker → replaced by celery-cpu-worker

  # Celery Flower patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: celery-flower
      spec:
        replicas: 1
        template:
          spec:
            serviceAccountName: examxv2-stg-secret-service
            containers:
            - name: flower
              image: "399600302704.dkr.ecr.ap-south-1.amazonaws.com/examxv2-backend:stg-EXM-1809-Update-Authoring-Module-Re-ad2c938a641b85c2fc9d53c1894737f8ccb540c4"
              resources:
                requests:
                  cpu: "200m"
                  memory: "512Mi"
                limits:
                  cpu: "400m"
                  memory: "1Gi"
    target:
      kind: Deployment
      name: celery-flower

  # Ingress patches
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: examxv2-ingress
        annotations:
          alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-south-1:399600302704:certificate/3ac85857-f810-414f-903b-1ab46d8e1520
          alb.ingress.kubernetes.io/auth-tls-verify-client: "optional"
          alb.ingress.kubernetes.io/cors-allow-origin: >-
            https://examx.co,https://www.examx.co,https://*.examx.co
      spec:
        tls:
          - hosts:
              - examx.co
            secretName: tls-secret
    target:
      kind: Ingress
      name: examxv2-ingress

  # Secrets patches
  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-backend-secrets
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-stage-secrets-DKS1E3
              objectAlias: ".env"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-backend-secrets

  - patch: |-
      apiVersion: secrets-store.csi.x-k8s.io/v1
      kind: SecretProviderClass
      metadata:
        name: examxv2-google-credentials
      spec:
        parameters:
          objects: |
            - objectName: arn:aws:secretsmanager:ap-south-1:399600302704:secret:examxv2-backend-googlecredentials-stg-w86vvd
              objectAlias: "google-credentials.json"
              objectType: "secretsmanager"
    target:
      kind: SecretProviderClass
      name: examxv2-google-credentials
